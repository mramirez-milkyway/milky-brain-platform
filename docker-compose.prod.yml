services:
  api:
    image: ${ECR_REGISTRY}/milky-way-api:${IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      JWT_SECRET: ${JWT_SECRET}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET}
      REFRESH_TOKEN_EXPIRY: ${REFRESH_TOKEN_EXPIRY:-30d}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL}
      FRONTEND_URL: ${FRONTEND_URL}
      MAX_AUDIT_EXPORT_MONTHS: ${MAX_AUDIT_EXPORT_MONTHS:-3}
      RESEND_API_KEY: ${RESEND_API_KEY}
      FROM_EMAIL: ${FROM_EMAIL}
      ALLOWED_INVITE_DOMAINS: ${ALLOWED_INVITE_DOMAINS}
      INVITATION_EXPIRY_DAYS: ${INVITATION_EXPIRY_DAYS:-30}
    ports:
      - '4000:4000'
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:4000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    logging:
      driver: awslogs
      options:
        awslogs-region: ${AWS_REGION:-eu-south-2}
        awslogs-group: /aws/ec2/${ENVIRONMENT:-prod}/api
        awslogs-create-group: 'true'

  web:
    image: ${ECR_REGISTRY}/milky-way-web-admin:${IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    ports:
      - '3000:3000'
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    logging:
      driver: awslogs
      options:
        awslogs-region: ${AWS_REGION:-eu-south-2}
        awslogs-group: /aws/ec2/${ENVIRONMENT:-prod}/web
        awslogs-create-group: 'true'

networks:
  default:
    name: milky-way-network
