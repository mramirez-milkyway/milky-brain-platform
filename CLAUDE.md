<!-- OPENSPEC:START -->
# OpenSpec Instructions

These instructions are for AI assistants working in this project.

Always open `@/openspec/AGENTS.md` when the request:
- Mentions planning or proposals (words like proposal, spec, change, plan)
- Introduces new capabilities, breaking changes, architecture shifts, or big performance/security work
- Sounds ambiguous and you need the authoritative spec before coding

Use `@/openspec/AGENTS.md` to learn:
- How to create and apply change proposals
- Spec format and conventions
- Project structure and guidelines

Keep this managed block so 'openspec update' can refresh the instructions.

<!-- OPENSPEC:END -->

# AGENTS.md

## Objective
These are the rules any AI agent MUST follow without exception.

---

## Database Rules
* Database: **PostgreSQL**
* ORM: **PrismaORM**
* Migrations: **Prisma ORM migrations module**
* Always run `npx prisma migrate dev --name={migration_name}"` from the proper env context to generate new migrations, even for empty ones.
* Never create blank migrations manually; edit the autogenerated one if needed.
* Each migration must ensure no data loss. In production, rename existing tables with `_bkp_{timestamp}` before destructive changes and migrate data forward.
* During local development, destructive schema changes are acceptable if migrations remain idempotent.

---

## Backend Rules
* Backend: **NestJS** API (REST)
* Abide by SOLID principles. No library coupling that prevents replacing ORM or framework.
* Controllers handle HTTP and validation only; no business logic.
* Services implement stateless business logic.
* Repositories abstract database access.
* Schemas define request/response DTOs.
* Unit tests mandatory under `/tests` using **pytest**.
* Tests must isolate logic (mock DB/network).
* Files ends with `.spec.ts` and live under `/tests/unit` inside the app folder.
* Use HTTP-only, Secure cookies for communication; include CSRF tokens for mutating requests.
* Background jobs must use **Lambda + SQS**.
* Configuration strictly via environment variables (.env files).

---

## Frontend Rules
* Frontend: **React + NextJS** avoid using the NextJS API capabilities, just keep it for proxy concerns, but try to avoid it
* Use **TanStack Query** for data fetching and caching.
* Avoid `useEffect` unless absolutely necessary, do not handle app state inside it.
* Use **Zustand** for global state management.
* Use **TailwindCSS** for styling (no inline styles).
* Follow SOLID and avoid React anti-patterns.
* Unit tests mandatory using **react-testing-library**.
* Tests live under `/test` folder inside the client app mirroring the folder structure.

---

## General Rules
* Keep a **Makefile** to run backend, frontend, and tests separately.
* Use **eslint/prettier** for Typescript linting.
* Never hardcode secrets or API keys.
* Do not modify or break unrelated features.
* If something is unclear, ask for clarification â€” **never assume.**
* The app is a turborepo monorepo
* Usage of type `any` is STRICLY PROHIBITED, `unknown` must be used instead, and parsed to a type when needed.

---

## Infrastructure
* Infra is done via IaC (Terraform)
* Nothing can be created manually with AWS cli, everything must live under Terraform inside folder `/infrastructure`
