name: Deploy to Environment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - qa
          - prod

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'eu-south-2' }}

jobs:
  build-and-push:
    name: Build and Push to ECR (${{ github.event.inputs.environment }})
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: set-tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "image_tag=${{ github.event.inputs.environment }}-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push API image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: milky-way-api
          IMAGE_TAG: ${{ steps.set-tag.outputs.image_tag }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
                       -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
                       --target production \
                       -f apps/api/Dockerfile \
                       .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Set API URL for environment
        id: set-api-url
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "prod" ]]; then
            echo "api_url=${{ secrets.PROD_API_URL }}" >> $GITHUB_OUTPUT
          else
            echo "api_url=${{ secrets.QA_API_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Web Admin image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: milky-way-web-admin
          IMAGE_TAG: ${{ steps.set-tag.outputs.image_tag }}
          NEXT_PUBLIC_API_URL: ${{ steps.set-api-url.outputs.api_url }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
                       -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
                       --build-arg NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL \
                       --target production \
                       -f apps/web-admin/Dockerfile \
                       .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Image build summary
        run: |
          echo "### Docker Images Built :whale:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **API:** ${{ steps.login-ecr.outputs.registry }}/milky-way-api:${{ steps.set-tag.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Web Admin:** ${{ steps.login-ecr.outputs.registry }}/milky-way-web-admin:${{ steps.set-tag.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY

  deploy-lambda:
    name: Deploy Lambda Function (${{ github.event.inputs.environment }})
    runs-on: ubuntu-latest
    needs: build-and-push

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for Lambda code changes
        id: check-lambda
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q '^lambdas/job-processor/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Lambda code changed, will deploy"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Lambda code unchanged, skipping deployment"
          fi

      - name: Set up Node.js
        if: steps.check-lambda.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure AWS credentials
        if: steps.check-lambda.outputs.changed == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build Lambda package
        if: steps.check-lambda.outputs.changed == 'true'
        working-directory: lambdas/job-processor
        run: |
          # Clean previous build
          rm -rf dist *.zip

          # Install dependencies first
          echo "Installing dependencies..."
          npm install

          # Copy Prisma schema and generate client BEFORE compiling TypeScript
          echo "Generating Prisma client..."
          mkdir -p prisma
          cp ../../apps/api/prisma/schema.prisma prisma/schema.prisma
          npx prisma generate

          # Compile TypeScript (now Prisma types are available)
          echo "Compiling TypeScript..."
          npx tsc

          # Install production dependencies
          echo "Installing production dependencies..."
          rm -rf node_modules
          npm install --omit=dev

          # Create deployment package
          echo "Creating deployment package..."
          cd dist && zip -r ../lambda.zip . && cd ..
          zip -r lambda.zip node_modules/ package.json -x "node_modules/@types/*" "node_modules/@jest/*" "node_modules/*/test/*" "node_modules/*/tests/*" "node_modules/*/*.md" "node_modules/*/LICENSE*" "node_modules/.bin/*"

          echo "Lambda package size: $(ls -lh lambda.zip | awk '{print $5}')"

      - name: Upload Lambda package to S3
        if: steps.check-lambda.outputs.changed == 'true'
        working-directory: lambdas/job-processor
        run: |
          BUCKET_NAME="${{ github.event.inputs.environment }}-milky-way-lambda-deployments"
          S3_KEY="job-processor/lambda-${{ github.sha }}.zip"

          # Create bucket if it doesn't exist
          aws s3 mb s3://$BUCKET_NAME --region ${{ env.AWS_REGION }} 2>/dev/null || true

          # Upload to S3
          echo "Uploading lambda.zip to s3://$BUCKET_NAME/$S3_KEY"
          aws s3 cp lambda.zip s3://$BUCKET_NAME/$S3_KEY --region ${{ env.AWS_REGION }}

          echo "s3_bucket=$BUCKET_NAME" >> $GITHUB_ENV
          echo "s3_key=$S3_KEY" >> $GITHUB_ENV

      - name: Deploy Lambda function from S3
        if: steps.check-lambda.outputs.changed == 'true'
        run: |
          FUNCTION_NAME="${{ github.event.inputs.environment }}-milky-way-job-processor"

          echo "Deploying to Lambda function: $FUNCTION_NAME from S3"

          aws lambda update-function-code \
            --function-name $FUNCTION_NAME \
            --s3-bucket ${{ env.s3_bucket }} \
            --s3-key ${{ env.s3_key }} \
            --region ${{ env.AWS_REGION }}

          echo "Waiting for function to update..."
          aws lambda wait function-updated \
            --function-name $FUNCTION_NAME \
            --region ${{ env.AWS_REGION }}

          echo "Lambda function deployed successfully!"

      - name: Lambda deployment summary
        if: steps.check-lambda.outputs.changed == 'true'
        run: |
          echo "### Lambda Deployment :zap:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Function:** ${{ github.event.inputs.environment }}-milky-way-job-processor" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Deployed" >> $GITHUB_STEP_SUMMARY

      - name: Lambda deployment skipped
        if: steps.check-lambda.outputs.changed == 'false'
        run: |
          echo "### Lambda Deployment :zap:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Skipped (no changes detected)" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-lambda]

    environment:
      name: ${{ github.event.inputs.environment }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: set-tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "image_tag=${{ github.event.inputs.environment }}-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Set EC2 host
        id: set-host
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "prod" ]]; then
            echo "ec2_host=${{ secrets.PROD_EC2_HOST }}" >> $GITHUB_OUTPUT
          else
            echo "ec2_host=${{ secrets.QA_EC2_HOST }}" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ steps.set-host.outputs.ec2_host }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ steps.set-host.outputs.ec2_host }}
          ENVIRONMENT: ${{ github.event.inputs.environment }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          AWS_REGION: ${{ env.AWS_REGION }}
          IMAGE_TAG: ${{ steps.set-tag.outputs.image_tag }}
        run: |
          # Copy deployment files to EC2
          scp -i ~/.ssh/deploy_key docker-compose.prod.yml ec2-user@$EC2_HOST:/tmp/
          scp -i ~/.ssh/deploy_key fetch-secrets.sh ec2-user@$EC2_HOST:/tmp/
          scp -i ~/.ssh/deploy_key scripts/deploy-ec2.sh ec2-user@$EC2_HOST:/tmp/

          ssh -i ~/.ssh/deploy_key ec2-user@$EC2_HOST bash -s -- \
            "$ECR_REGISTRY" \
            "$IMAGE_TAG" \
            "$ENVIRONMENT" \
            "$AWS_REGION" << 'ENDSSH'
            set -e

            # Get parameters passed from GitHub Actions
            ECR_REGISTRY="$1"
            IMAGE_TAG="$2"
            ENVIRONMENT="$3"
            AWS_REGION="$4"

            # Export for use in subshells and scripts
            export ECR_REGISTRY
            export IMAGE_TAG
            export ENVIRONMENT
            export AWS_REGION

            echo "=== Deployment Parameters ==="
            echo "ECR_REGISTRY: $ECR_REGISTRY"
            echo "IMAGE_TAG: $IMAGE_TAG"
            echo "ENVIRONMENT: $ENVIRONMENT"
            echo "AWS_REGION: $AWS_REGION"
            echo "============================"

            # Create app directory if it doesn't exist
            sudo mkdir -p /opt/app
            sudo chown -R ec2-user:ec2-user /opt/app

            # Move deployment files to app directory
            mv /tmp/docker-compose.prod.yml /opt/app/docker-compose.prod.yml
            mv /tmp/fetch-secrets.sh /opt/app/fetch-secrets.sh
            mv /tmp/deploy-ec2.sh /opt/app/deploy-ec2.sh
            chmod +x /opt/app/fetch-secrets.sh
            chmod +x /opt/app/deploy-ec2.sh

            # Navigate to app directory
            cd /opt/app

            # Run the deployment script
            ./deploy-ec2.sh
          ENDSSH

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Deployment summary
        run: |
          echo "### Deployment Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Host:** ${{ steps.set-host.outputs.ec2_host }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ steps.set-tag.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
